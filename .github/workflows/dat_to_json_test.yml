name: Mini DAT to JSON

on:
  workflow_dispatch:

jobs:
  dat-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Download DAT files
        uses: Loyalsoldier/v2ray-rules-dat-action@v1
        with:
          dat-dir: sources

      - name: Install dependencies
        run: |
          npm install @loyalsoldier/geosite

      - name: Convert DAT to JSON
        run: |
          node << 'EOF'
          const fs = require('fs');
          const geosite = require('@loyalsoldier/geosite');

          const DAT_FILE = 'sources/geosite.dat';
          const OUTPUT_JSON = 'aggregated_test.json';

          if (!fs.existsSync(DAT_FILE)) {
            console.error("❌ geosite.dat not found!");
            process.exit(1);
          }

          const rules = geosite.loadSync(DAT_FILE);

          const direct = [];
          const proxy = [];

          for (const [category, domains] of Object.entries(rules)) {
            if (category.includes("CN") || category.includes("RU")) {
              direct.push(...domains);
            } else {
              proxy.push(...domains);
            }
          }

          const aggregated = {
            direct: [...new Set(direct)],
            proxy: [...new Set(proxy)]
          };

          fs.writeFileSync(OUTPUT_JSON, JSON.stringify(aggregated, null, 2));
          console.log("✅ JSON created:", OUTPUT_JSON);
          console.log("Direct count:", aggregated.direct.length);
          console.log("Proxy count:", aggregated.proxy.length);
          EOF

      - name: Show JSON sample
        run: |
          head -n 20 aggregated_test.json