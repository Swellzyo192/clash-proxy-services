name: Auto Update Aggregated Rules (FULL)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.CLASH_PAT }}

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Download sources (robust)
      run: |
        mkdir -p sources

        echo "Downloading proxy.txt"
        if curl -sSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt -o sources/proxy.txt; then
          echo "✔ proxy.txt downloaded"
        else
          echo "❌ proxy.txt failed"
        fi

        echo "Downloading geosite"
        if curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geosite/main/data/russia.yaml -o sources/russia-geosite.yaml; then
          echo "✔ russia-geosite.yaml downloaded"
        else
          echo "❌ russia-geosite.yaml failed"
        fi

        echo "Downloading geoip ipv4.ipset"
        if curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/main/ipv4.ipset -o sources/ipv4.ipset; then
          echo "✔ ipv4.ipset downloaded"
        else
          echo "❌ ipv4.ipset failed"
        fi

        echo "Downloading geoip ipv6.ipset"
        if curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/main/ipv6.ipset -o sources/ipv6.ipset; then
          echo "✔ ipv6.ipset downloaded"
        else
          echo "❌ ipv6.ipset failed"
        fi

    - name: Generate JSON
      run: |
        node << 'EOF'
        const fs = require('fs');

        function readYamlList(path) {
          if (!fs.existsSync(path)) return [];
          const content = fs.readFileSync(path, "utf8");
          return content
            .split("\n")
            .map(l => l.trim())
            .filter(l => l.startsWith("- "))
            .map(l => l.slice(2).trim());
        }

        function readIpset(path) {
          if (!fs.existsSync(path)) return [];
          return fs.readFileSync(path, "utf8")
            .split("\n")
            .map(l => l.trim())
            .filter(l => l && !l.startsWith("#"));
        }

        function readProxy(path) {
          if (!fs.existsSync(path)) return [];
          return fs.readFileSync(path, "utf8")
            .split("\n")
            .map(l => l.trim())
            .filter(l => l && !l.startsWith("#"));
        }

        const geosite = readYamlList("sources/russia-geosite.yaml");
        const geoip_ipv4 = readIpset("sources/ipv4.ipset");
        const geoip_ipv6 = readIpset("sources/ipv6.ipset");
        const proxy = readProxy("sources/proxy.txt");

        console.log("→ Geosite count:", geosite.length);
        console.log("→ GeoIP IPv4 count:", geoip_ipv4.length);
        console.log("→ GeoIP IPv6 count:", geoip_ipv6.length);
        console.log("→ Proxy count:", proxy.length);

        const aggregated = {
          direct: [...new Set([...geosite, ...geoip_ipv4, ...geoip_ipv6])],
          proxy: [...new Set(proxy)]
        };

        if (!aggregated.direct.length) {
          console.error("❌ DIRECT list empty — abort!");
          process.exit(1);
        }
        if (!aggregated.proxy.length) {
          console.error("❌ PROXY list empty — abort!");
          process.exit(1);
        }

        fs.writeFileSync(
          "aggregated_rules.json",
          JSON.stringify(aggregated, null, 2)
        );

        console.log("✅ aggregated_rules.json created!");
        EOF

    - name: Commit & Push
      run: |
        git config user.name "swellzyo192"
        git config user.email "swellzyo@gmail.com"
        git add aggregated_rules.json
        git commit -m "Auto update aggregated rules" || echo "No changes"
        git push