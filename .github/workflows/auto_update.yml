name: Auto Update Aggregated Rules (DAT)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.CLASH_PAT }}

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Download sources
      run: |
        mkdir -p sources

        # proxy list
        echo "Downloading proxy.txt"
        curl -sSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt -o sources/proxy.txt

        # geosite dat
        echo "Downloading geosite.dat"
        curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geosite/release/geosite.dat -o sources/geosite.dat

        # geoip dat
        echo "Downloading geoip-ru-only.dat"
        curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/release/geoip-ru-only.dat -o sources/geoip.dat

        # проверка файлов
        for f in sources/*; do
          if [ ! -s "$f" ]; then
            echo "❌ File $f is empty — abort"
            exit 1
          fi
        done
        echo "✅ All sources downloaded"

    - name: Generate JSON
      run: |
        node << 'EOF'
        const fs = require('fs');

        function readProxy(path) {
          return fs.readFileSync(path, 'utf8')
            .split('\n')
            .map(l => l.trim())
            .filter(l => l && !l.includes("404"));
        }

        function readDat(path) {
          return fs.readFileSync(path, 'utf8')
            .split('\n')
            .map(l => l.trim())
            .filter(l => l && !l.includes("404"));
        }

        const proxy = readProxy("sources/proxy.txt");
        const geosite = readDat("sources/geosite.dat");
        const geoip = readDat("sources/geoip.dat");

        console.log("→ Proxy count:", proxy.length);
        console.log("→ Geosite count:", geosite.length);
        console.log("→ GeoIP count:", geoip.length);

        const aggregated = {
          direct: [...new Set([...geosite, ...geoip])],
          proxy: [...new Set(proxy)]
        };

        if (!aggregated.direct.length) {
          console.error("❌ DIRECT list empty — abort!");
          process.exit(1);
        }
        if (!aggregated.proxy.length) {
          console.error("❌ PROXY list empty — abort!");
          process.exit(1);
        }

        fs.writeFileSync(
          "aggregated_rules.json",
          JSON.stringify(aggregated, null, 2)
        );
        console.log("✅ aggregated_rules.json created!");
        EOF

    - name: Commit & Push
      run: |
        git config user.name "swellzyo192"
        git config user.email "swellzyo@gmail.com"
        git add aggregated_rules.json
        git commit -m "Auto update aggregated rules" || echo "No changes"
        git push