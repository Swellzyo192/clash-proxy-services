name: Auto Update Aggregated Rules

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CLASH_PAT }}

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependency
        run: npm install js-yaml

      - name: Download sources
        run: |
          mkdir -p sources
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/master/proxy.txt -o sources/proxy.txt || true
          curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geosite/main/russia.yaml -o sources/russia.yaml || true
          curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/main/russia.yaml -o sources/russia-geoip.yaml || true

      - name: Generate JSON
        run: |
          cat > generate.js << 'EOF'
          const fs = require('fs');
          const yaml = require('js-yaml');

          let aggregated = { direct: [], proxy: [] };

          try {
            const geo = yaml.load(fs.readFileSync('sources/russia.yaml', 'utf8')) || {};
            aggregated.direct.push(...Object.keys(geo));
          } catch {}

          try {
            const geoip = yaml.load(fs.readFileSync('sources/russia-geoip.yaml', 'utf8')) || {};
            aggregated.direct.push(...Object.keys(geoip));
          } catch {}

          try {
            const proxy = fs.readFileSync('sources/proxy.txt', 'utf8')
              .split(/\r?\n/)
              .filter(Boolean);
            aggregated.proxy.push(...proxy);
          } catch {}

          for (let k in aggregated) {
            aggregated[k] = [...new Set(aggregated[k])];
          }

          fs.writeFileSync('aggregated_rules.json', JSON.stringify(aggregated, null, 2));
          console.log("Generated successfully");
          EOF

          node generate.js

      - name: Commit & Push
        run: |
          git config user.name "swellzyo192"
          git config user.email "swellzyo@gmail.com"
          git add aggregated_rules.json
          git commit -m "Auto update aggregated rules" || echo "No changes"
          git push