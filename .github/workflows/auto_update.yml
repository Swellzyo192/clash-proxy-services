name: Auto Update Aggregated Rules (WORKING)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.CLASH_PAT }}

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Download sources
      run: |
        set -e
        mkdir -p sources

        # proxy list
        curl -fSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt \
          -o sources/proxy.txt

        # geosite domains
        curl -fSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geosite/main/data/russia.yaml \
          -o sources/russia-geosite.yaml

        # geoip ipset
        curl -fSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/main/ip.ipset \
          -o sources/russia-geoip.ipset

        echo "✅ All sources downloaded successfully"

    - name: Generate JSON
      run: |
        node << 'EOF'
        const fs = require('fs');

        function readYamlList(path) {
          const content = fs.readFileSync(path, "utf8");
          return content
            .split("\n")
            .map(l => l.trim())
            .filter(l => l.startsWith("- "))
            .map(l => l.slice(2).trim());
        }

        function readIpset(path) {
          return fs.readFileSync(path, "utf8")
            .split("\n")
            .map(l => l.trim())
            .filter(l => l && !l.startsWith("#"));
        }

        function readProxy(path) {
          return fs.readFileSync(path, "utf8")
            .split("\n")
            .map(l => l.trim())
            .filter(l => l && !l.startsWith("#"));
        }

        const geosite = readYamlList("sources/russia-geosite.yaml");
        const geoip   = readIpset("sources/russia-geoip.ipset");
        const proxy   = readProxy("sources/proxy.txt");

        console.log("→ Geosite count:", geosite.length);
        console.log("→ GeoIP count:", geoip.length);
        console.log("→ Proxy count:", proxy.length);

        const aggregated = {
          direct: [...new Set([...geosite, ...geoip])],
          proxy: [...new Set(proxy)]
        };

        if (!aggregated.direct.length) {
          console.error("❌ DIRECT list empty — abort!");
          process.exit(1);
        }
        if (!aggregated.proxy.length) {
          console.error("❌ PROXY list empty — abort!");
          process.exit(1);
        }

        fs.writeFileSync(
          "aggregated_rules.json",
          JSON.stringify(aggregated, null, 2)
        );

        console.log("✅ aggregated_rules.json created!");
        EOF

    - name: Commit & Push
      run: |
        git config user.name "swellzyo192"
        git config user.email "swellzyo@gmail.com"
        git add aggregated_rules.json
        git commit -m "Auto update aggregated rules" || echo "No changes"
        git push