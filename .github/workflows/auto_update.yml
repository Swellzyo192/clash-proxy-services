name: Auto Update Aggregated Rules (FINAL)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CLASH_PAT }}

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Install dependency
        run: npm install js-yaml

      # =============================
      # STRICT DOWNLOAD
      # =============================
      - name: Download sources
        run: |
          set -e
          mkdir -p sources

          curl -fSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt \
            -o sources/proxy.txt

          curl -fSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geosite/main/data/russia.yaml \
            -o sources/russia.yaml

          curl -fSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/main/data/russia.yaml \
            -o sources/russia-geoip.yaml

          echo "✅ Sources downloaded"

      # =============================
      # GENERATE JSON CORRECTLY
      # =============================
      - name: Generate JSON
        run: |
          cat > generate.js << 'EOF'
          const fs = require('fs');
          const yaml = require('js-yaml');

          function readYamlPayload(path) {
            try {
              const content = fs.readFileSync(path, 'utf8');
              const parsed = yaml.load(content);
              if (!parsed || !parsed.payload || !Array.isArray(parsed.payload)) {
                console.warn(`⚠ Invalid structure in ${path}`);
                return [];
              }
              return parsed.payload;
            } catch (e) {
              console.error(`❌ Failed parsing ${path}:`, e.message);
              return [];
            }
          }

          function readProxyList(path) {
            return fs.readFileSync(path, 'utf8')
              .split(/\r?\n/)
              .filter(line => line && !line.startsWith('#'));
          }

          let aggregated = {
            direct: [],
            proxy: []
          };

          const geosite = readYamlPayload('sources/russia.yaml');
          const geoip = readYamlPayload('sources/russia-geoip.yaml');
          const proxy = readProxyList('sources/proxy.txt');

          console.log("Geosite entries:", geosite.length);
          console.log("GeoIP entries:", geoip.length);
          console.log("Proxy entries:", proxy.length);

          aggregated.direct = [...new Set([...geosite, ...geoip])];
          aggregated.proxy = [...new Set(proxy)];

          console.log("Final DIRECT:", aggregated.direct.length);
          console.log("Final PROXY:", aggregated.proxy.length);

          if (aggregated.direct.length === 0 || aggregated.proxy.length === 0) {
            console.error("❌ Empty result — aborting");
            process.exit(1);
          }

          fs.writeFileSync(
            'aggregated_rules.json',
            JSON.stringify(aggregated, null, 2)
          );

          console.log("✅ JSON generated successfully");
          EOF

          node generate.js

      # =============================
      # COMMIT & PUSH
      # =============================
      - name: Commit & Push
        run: |
          git config user.name "swellzyo192"
          git config user.email "swellzyo@gmail.com"

          git add aggregated_rules.json
          git commit -m "Auto update aggregated rules" || echo "No changes"
          git push