name: Auto Update Clean Aggregated Rules

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.CLASH_PAT }}

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Download text sources
      run: |
        mkdir -p sources

        # proxy list
        curl -sSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt -o sources/proxy.txt

        # geosite (текстовый вариант)
        curl -sSL https://raw.githubusercontent.com/Swellzyo192/working-text-sources/main/russia.txt -o sources/russia.txt

        # ipv4/ipv6 (текстовые списки, если есть)
        curl -sSL https://raw.githubusercontent.com/Swellzyo192/working-text-sources/main/ipv4.txt -o sources/ipv4.txt || echo "No ipv4.txt"
        curl -sSL https://raw.githubusercontent.com/Swellzyo192/working-text-sources/main/ipv6.txt -o sources/ipv6.txt || echo "No ipv6.txt"

        # проверка файлов
        for f in sources/proxy.txt sources/russia.txt; do
          if [ ! -s "$f" ]; then
            echo "❌ File $f is empty — abort"
            exit 1
          fi
        done

        echo "✅ All text sources downloaded"

    - name: Generate clean JSON
      run: |
        node << 'EOF'
        const fs = require('fs');

        function readLines(path) {
          if (!fs.existsSync(path)) return [];
          return fs.readFileSync(path, 'utf8')
            .split('\n')
            .map(l => l.trim())
            .filter(l => l && !l.includes("404"));
        }

        const proxy = readLines("sources/proxy.txt");
        const geosite = readLines("sources/russia.txt");
        const ipv4 = readLines("sources/ipv4.txt");
        const ipv6 = readLines("sources/ipv6.txt");

        const aggregated = {
          direct: [...new Set([...geosite, ...ipv4, ...ipv6])],
          proxy: [...new Set(proxy)]
        };

        fs.writeFileSync(
          "aggregated_rules.json",
          JSON.stringify(aggregated, null, 2)
        );

        console.log("✅ aggregated_rules.json created!");
        EOF

    - name: Commit & Push
      run: |
        git config user.name "swellzyo192"
        git config user.email "swellzyo@gmail.com"
        git add aggregated_rules.json
        git commit -m "Auto update clean aggregated rules" || echo "No changes"
        git push