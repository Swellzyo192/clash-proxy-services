name: Auto Update Clean Aggregated Rules with Checks

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repo
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.CLASH_PAT }}

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Download text sources with checks
      run: |
        mkdir -p sources

        # Список текстовых файлов с рабочими ссылками
        declare -A files
        files=(
          ["proxy.txt"]="https://raw.githubusercontent.com/Loyalsoldier/clash-rules/release/proxy.txt"
          ["russia.txt"]="https://raw.githubusercontent.com/Swellzyo192/working-text-sources/main/russia.txt"
          ["ipv4.txt"]="https://raw.githubusercontent.com/Swellzyo192/working-text-sources/main/ipv4.txt"
          ["ipv6.txt"]="https://raw.githubusercontent.com/Swellzyo192/working-text-sources/main/ipv6.txt"
        )

        for f in "${!files[@]}"; do
          url=${files[$f]}
          echo "Downloading $f from $url"
          curl -sSL "$url" -o "sources/$f"
          if [ ! -s "sources/$f" ]; then
            echo "❌ $f is empty or 404 — abort"
            exit 1
          fi
        done
        echo "✅ All sources downloaded successfully"

    - name: Generate clean JSON
      run: |
        node << 'EOF'
        const fs = require('fs');

        function cleanLines(path) {
          if (!fs.existsSync(path)) return [];
          return fs.readFileSync(path, 'utf8')
            .split('\n')
            .map(l => l.trim())
            .filter(l => l && l !== "404: Not Found" && l !== "payload:" && !l.startsWith("- "));
        }

        const proxy = cleanLines("sources/proxy.txt");
        const geosite = cleanLines("sources/russia.txt");
        const ipv4 = cleanLines("sources/ipv4.txt");
        const ipv6 = cleanLines("sources/ipv6.txt");

        if (!proxy.length) throw new Error("Proxy list is empty! Check source URL.");
        if (!geosite.length && !ipv4.length && !ipv6.length) throw new Error("Direct list is empty! Check source URLs.");

        const aggregated = {
          direct: [...new Set([...geosite, ...ipv4, ...ipv6])],
          proxy: [...new Set(proxy)]
        };

        fs.writeFileSync("aggregated_rules.json", JSON.stringify(aggregated, null, 2));
        console.log("✅ aggregated_rules.json created!");
        console.log("Direct rules:", aggregated.direct.length);
        console.log("Proxy rules:", aggregated.proxy.length);
        EOF

    - name: Commit & Push
      run: |
        git config user.name "swellzyo192"
        git config user.email "swellzyo@gmail.com"
        git add aggregated_rules.json
        git commit -m "Auto update clean aggregated rules" || echo "No changes"
        git push