name: Generate Aggregated Rules (fixed)

on:
  schedule:
    - cron: '0 3 * * *'  # ежедневно в 03:00 UTC
  workflow_dispatch:      # ручной запуск

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout репозитория
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3️⃣ Установка js-yaml
      - name: Install js-yaml
        run: npm install js-yaml

      # 4️⃣ Скачать источники правил
      - name: Download sources
        run: |
          mkdir -p sources
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/master/proxy.txt -o sources/proxy.txt || echo "proxy.txt not downloaded"
          curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geosite/main/russia.yaml -o sources/russia.yaml || echo "russia.yaml not downloaded"
          curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/main/russia.yaml -o sources/russia-geoip.yaml || echo "russia-geoip.yaml not downloaded"

      # 5️⃣ Создать JS файл для генерации aggregated_rules.json
      - name: Write Node script
        run: |
          cat > generate.js << 'EOF'
          const fs = require('fs');
          const yaml = require('js-yaml');

          let aggregated = { direct: [], proxy: [] };

          // GEOsite
          try {
            const geoSiteContent = fs.readFileSync('sources/russia.yaml', 'utf8');
            const geoSite = yaml.load(geoSiteContent) || {};
            aggregated.direct.push(...Object.keys(geoSite));
          } catch(e){ console.error(e) }

          // GEOIP
          try {
            const geoIPContent = fs.readFileSync('sources/russia-geoip.yaml', 'utf8');
            const geoIP = yaml.load(geoIPContent) || {};
            aggregated.direct.push(...Object.keys(geoIP));
          } catch(e){ console.error(e) }

          // Proxy
          try {
            const proxyList = fs.readFileSync('sources/proxy.txt', 'utf8').split(/\r?\n/).filter(Boolean);
            aggregated.proxy.push(...proxyList);
          } catch(e){ console.error(e) }

          // Deduplicate
          for (let key in aggregated) {
            aggregated[key] = Array.from(new Set(aggregated[key]));
          }

          fs.writeFileSync('aggregated_rules.json', JSON.stringify(aggregated, null, 2));
          console.log("✅ aggregated_rules.json создан успешно");
          EOF

      # 6️⃣ Запустить Node.js скрипт
      - name: Run Node script
        run: node generate.js

      # 7️⃣ Проверка наличия файла
      - name: Verify file exists
        run: |
          if [ ! -f aggregated_rules.json ]; then
            echo "❌ aggregated_rules.json не найден"
            exit 1
          else
            echo "✅ aggregated_rules.json найден, готов к upload"
          fi

      # 8️⃣ Upload artifact
      - name: Upload aggregated_rules.json as artifact
        uses: actions/upload-artifact@v3
        with:
          name: aggregated_rules
          path: aggregated_rules.json
