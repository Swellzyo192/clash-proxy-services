name: Build and Update Clash JSON

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # ежедневно в 03:00 UTC

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      - name: Checkout repository with PAT
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # ------------------------------
      - name: Download proxy list
        run: |
          mkdir -p sources
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/proxy-list.txt -o sources/proxy-list.txt

      - name: Download direct list
        run: |
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o sources/direct-list.txt

      # ------------------------------
      - name: Build aggregated_rules.json
        run: |
          python3 - << 'EOF'
          import json

          def read_lines(path):
              with open(path, "r", encoding="utf-8") as f:
                  lines = [l.strip() for l in f.read().splitlines() if l.strip()]
                  # фильтр мусорных строк
                  return [l for l in lines if not l.startswith("404") and "." in l]

          proxy = read_lines("sources/proxy-list.txt")
          direct = read_lines("sources/direct-list.txt")

          aggregated = {
              "direct": sorted(set(direct)),
              "proxy": sorted(set(proxy)),
          }

          with open("aggregated_rules.json", "w", encoding="utf-8") as f:
              json.dump(aggregated, f, indent=2)

          print(f"✅ Built aggregated_rules.json: direct={len(aggregated['direct'])}, proxy={len(aggregated['proxy'])}")
          EOF

      # ------------------------------
      - name: Show JSON sample
        run: head -n 20 aggregated_rules.json

      # ------------------------------
      - name: Commit & Push if changed
        run: |
          git config user.name "swellzyo192"
          git config user.email "swellzyo@gmail.com"
          git add aggregated_rules.json
          # проверяем, есть ли изменения
          if ! git diff --cached --quiet; then
            git commit -m "Auto update aggregated rules"
            git push origin main
            echo "✅ JSON pushed, changes committed."
          else
            echo "ℹ️ No changes detected, nothing to commit."
          fi