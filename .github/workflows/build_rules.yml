name: Build and Update Clash Rules

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"  # –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 03:00 UTC

permissions:
  contents: write  # –¥–∞—ë–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------
      - name: Checkout repository with PAT
        uses: actions/checkout@v4  # –æ–±–Ω–æ–≤–∏–ª –¥–æ v4
        with:
          token: ${{ secrets.PAT_TOKEN }}

      # ------------------------------
      - name: Download proxy list
        run: |
          mkdir -p sources
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/proxy-list.txt -o sources/proxy-list.txt

      - name: Download direct list
        run: |
          curl -fsSL https://raw.githubusercontent.com/Loyalsoldier/v2ray-rules-dat/release/direct-list.txt -o sources/direct-list.txt

      # ------------------------------
      - name: Build aggregated_rules.json with logging
        run: |
          python3 - << 'EOF'
          import json
          import os

          def read_lines(path):
              with open(path, "r", encoding="utf-8") as f:
                  lines = [l.strip() for l in f.read().splitlines() if l.strip()]
                  # —Ñ–∏–ª—å—Ç—Ä –º—É—Å–æ—Ä–Ω—ã—Ö —Å—Ç—Ä–æ–∫
                  return [l for l in lines if not l.startswith("404") and "." in l]

          proxy = read_lines("sources/proxy-list.txt")
          direct = read_lines("sources/direct-list.txt")

          aggregated = {
              "direct": sorted(set(direct)),
              "proxy": sorted(set(proxy)),
          }

          # —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Ñ–∞–π–ª–æ–º –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
          old_file = "aggregated_rules.json"
          old_data = {"direct": [], "proxy": []}
          if os.path.exists(old_file):
              with open(old_file, "r", encoding="utf-8") as f:
                  old_data = json.load(f)

          new_direct = len(aggregated["direct"]) - len(old_data.get("direct", []))
          new_proxy = len(aggregated["proxy"]) - len(old_data.get("proxy", []))

          with open(old_file, "w", encoding="utf-8") as f:
              json.dump(aggregated, f, indent=2)

          print(f"‚úÖ Built aggregated_rules.json: direct={len(aggregated['direct'])} (+{new_direct}), proxy={len(aggregated['proxy'])} (+{new_proxy})")
          EOF

      # ------------------------------
      - name: Show JSON sample
        run: head -n 20 aggregated_rules.json

      # üëá –ù–û–í–´–ï –®–ê–ì–ò: –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è JSON ‚Üí YAML
      - name: Setup Python for YAML conversion
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Convert JSON to Clash rules
        run: |
          python3 - << 'EOF'
          import json
          import yaml
          import os

          print("üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º JSON –≤ –ø—Ä–∞–≤–∏–ª–∞ Clash...")
          
          # –ß–∏—Ç–∞–µ–º JSON
          with open('aggregated_rules.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          print(f"üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ: direct={len(data.get('direct', []))}, proxy={len(data.get('proxy', []))}")
          
          # –°–æ–∑–¥–∞—ë–º –ø—Ä–∞–≤–∏–ª–∞
          rules = []
          
          # –°–Ω–∞—á–∞–ª–∞ DIRECT (–≤–∞–∂–Ω–æ –¥–ª—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
          for domain in data.get('direct', []):
              rules.append(f"DOMAIN-SUFFIX,{domain},DIRECT")
          
          # –ü–æ—Ç–æ–º PROXY
          for domain in data.get('proxy', []):
              rules.append(f"DOMAIN-SUFFIX,{domain},Proxy")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ YAML
          config = {'rules': rules}
          
          with open('clash_rules.yaml', 'w', encoding='utf-8') as f:
              yaml.dump(config, f, allow_unicode=True, default_flow_style=False)
          
          print(f"‚úÖ –°–æ–∑–¥–∞–Ω–æ {len(rules)} –ø—Ä–∞–≤–∏–ª")
          
          # –ü–æ–∫–∞–∂–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
          direct_count = len(data.get('direct', []))
          proxy_count = len(data.get('proxy', []))
          print(f"üìä –ò—Ç–æ–≥–æ: DIRECT={direct_count}, PROXY={proxy_count}")
          EOF

      - name: Show YAML sample
        run: head -n 20 clash_rules.yaml

      # üëá –û–ë–ù–û–í–õ–Å–ù–ù–´–ô –®–ê–ì: –ö–æ–º–º–∏—Ç –æ–±–æ–∏—Ö —Ñ–∞–π–ª–æ–≤
      - name: Commit & Push if changed
        run: |
          git config user.name "swellzyo192"
          git config user.email "swellzyo@gmail.com"
          
          # –î–æ–±–∞–≤–ª—è–µ–º –æ–±–∞ —Ñ–∞–π–ª–∞
          git add aggregated_rules.json clash_rules.yaml
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if ! git diff --cached --quiet; then
            git commit -m "Auto update rules: JSON + YAML"
            git push origin main
            echo "‚úÖ JSON –∏ YAML –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã"
          else
            echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–æ–º–º–∏—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          fi
