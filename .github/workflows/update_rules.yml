name: Update Aggregated Rules

on:
  schedule:
    # Ежедневно в 03:00 UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Можно запускать вручную

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout репозитория
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2️⃣ Установка Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 3️⃣ Установка библиотеки js-yaml
      - name: Install js-yaml
        run: npm install js-yaml

      # 4️⃣ Скачать внешние источники правил
      - name: Download external rule sources
        run: |
          mkdir -p sources
          curl -sSL https://raw.githubusercontent.com/Loyalsoldier/clash-rules/master/proxy.txt -o sources/proxy.txt || echo "proxy.txt not downloaded"
          curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geosite/main/russia.yaml -o sources/russia.yaml || echo "russia.yaml not downloaded"
          curl -sSL https://raw.githubusercontent.com/runetfreedom/russia-blocked-geoip/main/russia.yaml -o sources/russia-geoip.yaml || echo "russia-geoip.yaml not downloaded"

      # 5️⃣ Генерация aggregated_rules.json
      - name: Generate aggregated_rules.json
        run: |
          node << 'EOF'
          const fs = require('fs');
          const yaml = require('js-yaml');

          let aggregated = {
            direct: [],
            proxy: [],
            proxy_social: [],
            proxy_stream: [],
            proxy_game: []
          };

          // Читаем GEO сайты РФ
          try {
            const geoSiteContent = fs.existsSync('sources/russia.yaml') ? fs.readFileSync('sources/russia.yaml', 'utf8') : '{}';
            const geoSite = yaml.load(geoSiteContent) || {};
            aggregated.direct.push(...Object.keys(geoSite));
          } catch(e){ console.error("Ошибка чтения Russia GEO:", e) }

          // Читаем GEO IP РФ
          try {
            const geoIPContent = fs.existsSync('sources/russia-geoip.yaml') ? fs.readFileSync('sources/russia-geoip.yaml', 'utf8') : '{}';
            const geoIP = yaml.load(geoIPContent) || {};
            aggregated.direct.push(...Object.keys(geoIP));
          } catch(e){ console.error("Ошибка чтения Russia GEOIP:", e) }

          // Читаем список прокси
          try {
            const proxyList = fs.existsSync('sources/proxy.txt') ? fs.readFileSync('sources/proxy.txt', 'utf8').split(/\r?\n/).filter(Boolean) : [];
            aggregated.proxy.push(...proxyList);
          } catch(e){ console.error("Ошибка чтения Proxy list:", e) }

          // Дедупликация
          for (let key in aggregated) {
            aggregated[key] = Array.from(new Set(aggregated[key]));
          }

          fs.writeFileSync('aggregated_rules.json', JSON.stringify(aggregated, null, 2));
          EOF

      # 6️⃣ Commit и push через GITHUB_TOKEN
      - name: Commit and push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add aggregated_rules.json
          git commit -m "Auto-update aggregated rules [skip ci]" || echo "No changes"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}